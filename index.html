<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Flashcard Hub</title>
  <style>
    :root {
      --primary-colors: #111,#212121,#2d2d2d,#1a237e,#1565c0,#00897b,#00695c,#b71c1c,#e65100,#c62828,#4527a0;
      --secondary-colors: #f8fafc,#f3e5f5,#e1f5fe,#ffe0b2,#f1f8e9,#fff9c4,#fce4ec,#fffde7,#e0f7fa;
      --shape-size: 80px;
      --shape-opacity: 0.13;
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Segoe UI',sans-serif;
      min-height: 100vh;
      margin: 0; padding: 0;
      color: var(--text-color);
      background: var(--minimal-bg, #f8fafc);
      position: relative;
      overflow-x: hidden;
    }

    /* Animated background shapes */
    .bg-shape {
      position: fixed;
      z-index: 0;
      opacity: var(--shape-opacity);
      filter: blur(1px);
      transition: all 1.5s cubic-bezier(.42,1.49,.6,.97);
      pointer-events: none;
    }

    /* Header */
    header {
      background: var(--primary-color, #111);
      color: var(--text-color, #fafafa);
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 2;
    }
    .menu-btn {
      background: none;
      border: none;
      color: var(--text-color, #fafafa);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.5rem;
      transition: background 0.2s;
      border-radius: 5px;
    }
    .menu-btn:hover { background: var(--button-hover, #333); }

    .menu {
      position: absolute;
      top: 100%; right: 1rem;
      background: var(--dropdown-bg, #222);
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      width: 200px; z-index: 100;
      display: none;
      color: var(--dropdown-text, #fafafa);
    }
    .menu.show { display: block; }
    .menu-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      border-bottom: 1px solid var(--dropdown-accent, #bdbdbd);
      color: var(--dropdown-text, #fafafa);
      background: var(--dropdown-bg, #222);
      transition: background 0.2s, color 0.2s;
    }
    .menu-item:last-child { border-bottom: none; }
    .menu-item:hover {
      background: var(--dropdown-item-hover, #333);
      color: var(--secondary-color, #e0e0e0);
    }

    /* Auth Section */
    #auth-section {
      max-width: 400px;
      margin: 2rem auto;
      padding: 2rem;
      background: #181818c5;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      color: var(--text-color, #fafafa);
      z-index: 1;
      position: relative;
    }
    .auth-title { text-align: center; color: var(--secondary-color, #e0e0e0); margin-bottom: 1.5rem; }
    .auth-form { display: flex; flex-direction: column; gap: 1rem; }
    .auth-input {
      padding: 0.75rem;
      border: 1px solid var(--medium-gray, #e0e0e0);
      border-radius: 5px;
      font-size: 1rem;
      background: #232323;
      color: var(--text-color, #fafafa);
    }
    .auth-input:focus { outline: none; border-color: var(--secondary-color, #e0e0e0); }
    .auth-button {
      background: var(--primary-color, #111);
      color: var(--text-color, #fafafa);
      border: none;
      padding: 0.75rem;
      border-radius: 5px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s;
    }
    .auth-button:hover { background: var(--button-hover, #444); }
    .auth-toggle { text-align: center; color: var(--secondary-color, #e0e0e0); margin-top: 1rem; }
    .auth-toggle span {
      color: var(--secondary-color, #e0e0e0);
      cursor: pointer;
      text-decoration: underline;
    }

    /* Main/Subject/Flashcard Views */
    #main, #subject-view, #account-settings, #change-password {
      padding: 1rem;
      display: none;
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255,255,255,0.85);
      border-radius: 14px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.07);
      color: #1a1a1a;
      position: relative;
      z-index: 1;
      margin-top: 1.5rem;
    }
    .section-title {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      color: var(--primary-color, #111);
    }
    .search-bar {
      width: 100%; padding: 0.75rem; margin-bottom: 1rem;
      border: 1px solid var(--medium-gray, #e0e0e0);
      border-radius: 5px; font-size: 1rem;
      background: var(--light-gray, #f5f5f5);
      color: #222;
    }
    .action-buttons {
      display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;
    }

    .btn {
      padding: 0.75rem 1rem;
      font-size: 1rem;
      background: var(--secondary-color, #e0e0e0);
      border: none; border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex; align-items: center; gap: 0.5rem;
      color: #181818;
    }
    .btn:hover {
      background: var(--button-hover, #444);
      color: var(--text-color, #fafafa);
      transform: translateY(-2px);
    }
    .btn-primary {
      background: var(--primary-color, #111);
      color: var(--text-color, #fafafa);
    }
    .btn-primary:hover {
      background: var(--button-hover, #444);
      color: var(--secondary-color, #e0e0e0);
    }
    .subject, .flashcard {
      display: flex; justify-content: space-between; align-items: center;
      padding: 1rem; margin: 0.5rem 0;
      border-radius: 12px;
      background-color: #fff;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(.42,1.49,.6,.97);
      box-shadow: 0 2px 5px rgba(0,0,0,0.07);
      color: #1a1a1a;
      border: 1px solid #f1f1f1;
      position: relative;
    }
    .subject:hover, .flashcard:hover {
      transform: translateY(-3px) scale(1.025);
      box-shadow: 0 4px 12px rgba(0,0,0,0.10);
    }

    /* Add geometric shapes to flashcards/subjects */
    .geo-shape {
      position: absolute;
      bottom: 7px; right: 9px;
      opacity: 0.13; z-index: 0;
      pointer-events: none;
      font-size: 2.4rem;
      user-select: none;
    }

    .tools { display: flex; gap: 0.5rem; }
    .tool-btn {
      background: none; border: none; cursor: pointer;
      font-size: 1rem; color: var(--dark-gray, #757575);
      transition: color 0.3s;
      z-index: 2;
    }
    .tool-btn:hover { color: var(--primary-color, #111); }
    .subject-container, .flashcard-container { margin-top: 1rem; }

    /* Settings Page */
    .settings-form { display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem; }
    .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
    .form-label { font-weight: 500; color: #181818; }
    .form-input {
      padding: 0.75rem; border: 1px solid var(--medium-gray, #e0e0e0);
      border-radius: 5px; font-size: 1rem;
      background: var(--light-gray, #f5f5f5); color: #181818;
    }
    .form-input:focus { outline: none; border-color: var(--primary-color, #111); }
    .back-btn { margin-bottom: 1rem; }

    @media (max-width: 600px) {
      header { padding: 0.75rem; }
      #auth-section { padding: 1.5rem; margin: 1rem; }
      .btn { padding: 0.5rem; font-size: 0.9rem; }
      .subject, .flashcard { padding: 0.75rem; }
      #main, #subject-view, #account-settings, #change-password { padding: 0.5rem; }
    }
  </style>
</head>
<body>
<div id="bg-shapes"></div>
<header>
  <h1>üìö Flashcard Hub</h1>
  <button class="menu-btn" id="menuBtn">‚ò∞</button>
  <div class="menu" id="menu">
    <div class="menu-item" onclick="showAccountSettings()">Account Settings</div>
    <div class="menu-item" onclick="showChangePassword()">Change Password</div>
    <div class="menu-item" onclick="logout()" style="color: #f44336;">Logout</div>
  </div>
</header>

<!-- Auth Section -->
<div id="auth-section">
  <h2 class="auth-title" id="authTitle">Sign In</h2>
  <div class="auth-form">
    <input type="text" id="username" class="auth-input" placeholder="Username" required>
    <input type="password" id="password" class="auth-input" placeholder="Password" required>
    <button onclick="handleAuth()" class="auth-button" id="auth-button">Sign In</button>
    <div class="auth-toggle">
      <span id="authToggleText" onclick="toggleAuth()">Don't have an account? Sign Up</span>
    </div>
  </div>
</div>

<!-- Main Dashboard -->
<div id="main">
  <input type="text" id="searchInput" class="search-bar" placeholder="üîç Search subjects..." oninput="filterSubjects()">
  <div class="action-buttons">
    <button class="btn btn-primary" onclick="addSubject()">
      <span>‚ûï</span> Add Subject
    </button>
  </div>
  <div class="section-title">üìÅ Your Subjects:</div>
  <div class="subject-container" id="subjectContainer"></div>
</div>

<!-- Subject View -->
<div id="subject-view">
  <button class="btn back-btn" onclick="backToMain()">‚¨Ö Back to Subjects</button>
  <h2 id="subjectTitle"></h2>
  <div class="action-buttons">
    <button class="btn btn-primary" onclick="addFlashcard()">
      <span>‚ûï</span> Add Flashcard
    </button>
    <button class="btn" onclick="shuffleFlashcards()">
      <span>üîÄ</span> Shuffle
    </button>
  </div>
  <div class="flashcard-container" id="flashcardContainer"></div>
</div>

<!-- Account Settings -->
<div id="account-settings">
  <button class="btn back-btn" onclick="backToMainFromSettings()">‚¨Ö Back</button>
  <h2>Account Settings</h2>
  <div class="settings-form">
    <div class="form-group">
      <label class="form-label">Name</label>
      <input type="text" id="userName" class="form-input">
    </div>
    <div class="form-group">
      <label class="form-label">Phone Number</label>
      <input type="tel" id="userPhone" class="form-input">
    </div>
    <div class="form-group">
      <label class="form-label">Address</label>
      <textarea id="userAddress" class="form-input" rows="3"></textarea>
    </div>
    <button class="btn btn-primary" onclick="saveAccountSettings()">Save Changes</button>
  </div>
</div>

<!-- Change Password -->
<div id="change-password">
  <button class="btn back-btn" onclick="backToMainFromSettings()">‚¨Ö Back</button>
  <h2>Change Password</h2>
  <div class="settings-form">
    <div class="form-group">
      <label class="form-label">Current Password</label>
      <input type="password" id="currentPassword" class="form-input" required>
    </div>
    <div class="form-group">
      <label class="form-label">New Password</label>
      <input type="password" id="newPassword" class="form-input" required>
    </div>
    <div class="form-group">
      <label class="form-label">Confirm New Password</label>
      <input type="password" id="confirmPassword" class="form-input" required>
    </div>
    <button class="btn btn-primary" onclick="changePassword()">Change Password</button>
  </div>
</div>

<script>
// ------ DYNAMIC COLOR & SHAPE BACKGROUND LOGIC ------
function randomFromArr(arr) { return arr[Math.floor(Math.random()*arr.length)]; }
function shuffleArr(arr) {
  // Fisher-Yates shuffle
  let a = arr.slice(), n = a.length;
  for (let i = n-1; i > 0; i--) {
    let j = Math.floor(Math.random() * (i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}
function randomInt(min,max) { return min + Math.floor(Math.random()*(max-min+1)); }

// Pick color themes and shapes on each refresh
const allPrimary = getComputedStyle(document.documentElement).getPropertyValue('--primary-colors').split(",");
const allSecondary = getComputedStyle(document.documentElement).getPropertyValue('--secondary-colors').split(",");
const bgShapes = [
  '<svg width="80" height="80"><circle cx="40" cy="40" r="38" fill="{c}" /></svg>',
  '<svg width="80" height="80"><rect x="8" y="8" width="64" height="64" rx="18" fill="{c}" /></svg>',
  '<svg width="80" height="80"><polygon points="40,8 72,72 8,72" fill="{c}" /></svg>',
  '<svg width="80" height="80"><ellipse cx="40" cy="48" rx="30" ry="20" fill="{c}" /></svg>',
  '<svg width="80" height="80"><line x1="12" y1="68" x2="68" y2="12" stroke="{c}" stroke-width="10" stroke-linecap="round"/></svg>',
  '<svg width="80" height="80"><path d="M40 8Q60 26 40 72Q20 26 40 8Z" fill="{c}" /></svg>',
  '<svg width="80" height="80"><polygon points="40,10 70,40 40,70 10,40" fill="{c}" /></svg>',
];
const shapeEmojis = ["üîµ","üî∂","üü©","üü£","üü¶","üüß","üü°","üü´","üî∫","‚¨õ","‚¨ú"];

function applyRandomTheme() {
  // Set color variables randomly
  const p = randomFromArr(allPrimary).trim();
  const s = randomFromArr(allSecondary).trim();
  const bgh = randomFromArr(allSecondary).trim();
  document.documentElement.style.setProperty('--primary-color', p);
  document.documentElement.style.setProperty('--secondary-color', s);
  document.documentElement.style.setProperty('--minimal-bg', bgh);
  document.documentElement.style.setProperty('--text-color', "#fafafa");
  document.documentElement.style.setProperty('--button-hover', "#333");
  document.documentElement.style.setProperty('--dropdown-bg', "#222");
  document.documentElement.style.setProperty('--dropdown-item-hover', "#333");
  document.documentElement.style.setProperty('--dropdown-text', "#fafafa");
  document.documentElement.style.setProperty('--dropdown-accent', "#bdbdbd");
  document.documentElement.style.setProperty('--light-gray', "#f5f5f5");
  document.documentElement.style.setProperty('--medium-gray', "#e0e0e0");
  document.documentElement.style.setProperty('--dark-gray', "#757575");
}
function drawRandomBGShapes() {
  // Minimal shapes in background at random places
  const num = window.innerWidth < 600 ? 3 : 6;
  const bg = document.getElementById('bg-shapes');
  bg.innerHTML = "";
  for (let i = 0; i < num; ++i) {
    const color = randomFromArr(allPrimary).trim();
    const svg = randomFromArr(bgShapes).replace("{c}",color);
    const div = document.createElement("div");
    div.className = "bg-shape";
    div.style.left = `${randomInt(3,90)}vw`;
    div.style.top = `${randomInt(4,80)}vh`;
    div.style.transform = `rotate(${randomInt(0,360)}deg) scale(${Math.random()*0.5+0.7})`;
    div.innerHTML = svg;
    bg.appendChild(div);
  }
}

applyRandomTheme();
drawRandomBGShapes();

// ----- END DYNAMIC BG/STYLE -------

// ----- SYNC DATA TO REMOTE (GitHub Gist) -----

const GIST_STORAGE_KEY = "flashcardhub_gistid";
const GIST_API = "https://api.github.com/gists";
let gistId = localStorage.getItem(GIST_STORAGE_KEY) || null;
let gistSyncTimer = null;

function getGistAuthHeader() {
  // For demo: no auth, but you can add GitHub PAT for real use as 'token ${token}'
  return {};
}

function getUserGistKey(user) {
  return `flashcardhub_${user}.json`;
}

// Save all users to gist (for demo: only user's own data is synced)
async function saveUserToGist(user, userData) {
  const filename = getUserGistKey(user);
  let desc = "FlashcardHub User Data";
  let files = {};
  files[filename] = {content: JSON.stringify(userData)};
  if (!gistId) {
    // Create new gist
    let res = await fetch(GIST_API, {
      method:'POST',
      headers: {'Content-Type':'application/json', ...getGistAuthHeader()},
      body: JSON.stringify({description:desc,public:false,files})
    });
    let data = await res.json();
    if (data.id) {
      gistId = data.id;
      localStorage.setItem(GIST_STORAGE_KEY, gistId);
    }
  } else {
    // Update gist
    await fetch(`${GIST_API}/${gistId}`, {
      method:'PATCH',
      headers: {'Content-Type':'application/json', ...getGistAuthHeader()},
      body: JSON.stringify({files})
    });
  }
}

async function loadUserFromGist(user) {
  if (!gistId) return null;
  const filename = getUserGistKey(user);
  let res = await fetch(`${GIST_API}/${gistId}`);
  let gist = await res.json();
  if (gist.files && gist.files[filename] && gist.files[filename].content) {
    return JSON.parse(gist.files[filename].content);
  }
  return null;
}

function debounceGistSync(user, userData) {
  clearTimeout(gistSyncTimer);
  gistSyncTimer = setTimeout(() => saveUserToGist(user, userData), 1500);
}

// ------ LOCAL/REMOTE DATA LOGIC -----
let isSignup = false;
let currentUser = null;
let currentSubject = null;

const subjectColors = allSecondary.map(x=>x.trim());
const flashcardColors = allPrimary.map(x=>x.trim());

// DOM Elements
const menuBtn = document.getElementById('menuBtn');
const menu = document.getElementById('menu');

// Event Listeners
menuBtn.addEventListener('click', () => { menu.classList.toggle('show'); });
document.addEventListener('click', (e) => { if (!menu.contains(e.target) && e.target !== menuBtn) menu.classList.remove('show'); });
window.addEventListener('resize', drawRandomBGShapes);

// Toggle between sign in and sign up
function toggleAuth() {
  isSignup = !isSignup;
  document.getElementById('auth-button').innerText = isSignup ? 'Sign Up' : 'Sign In';
  document.getElementById('authTitle').innerText = isSignup ? 'Sign Up' : 'Sign In';
  document.getElementById('authToggleText').innerText = isSignup ?
    'Already have an account? Sign In' : "Don't have an account? Sign Up";
}

// Handle authentication
async function handleAuth() {
  const user = document.getElementById('username').value.trim();
  const pass = document.getElementById('password').value.trim();

  if (!user || !pass) {
    alert('Please enter both username and password');
    return;
  }

  let users = JSON.parse(localStorage.getItem('users') || '{}');

  if (isSignup) {
    if (users[user]) {
      alert('User already exists!');
    } else {
      users[user] = {
        password: pass,
        data: {},
        profile: { name: '', phone: '', address: '' }
      };
      localStorage.setItem('users', JSON.stringify(users));
      await saveUserToGist(user, users[user]);
      alert('Signup successful! Please sign in.');
      toggleAuth();
    }
  } else {
    // Try remote load first
    let remote = await loadUserFromGist(user);
    if (remote) {
      users[user] = remote;
      localStorage.setItem('users', JSON.stringify(users));
    }
    if (users[user] && users[user].password === pass) {
      currentUser = user;
      document.getElementById('auth-section').style.display = 'none';
      document.getElementById('main').style.display = 'block';
      loadSubjects();
      loadProfileData();
    } else {
      alert('Incorrect credentials.');
    }
  }
  document.getElementById('username').value = '';
  document.getElementById('password').value = '';
}

// Get/set user data (auto-sync to gist)
function getUserData() {
  let users = JSON.parse(localStorage.getItem('users'));
  return users && users[currentUser] && users[currentUser].data ? users[currentUser].data : {};
}
function getUserProfile() {
  let users = JSON.parse(localStorage.getItem('users'));
  return users && users[currentUser] && users[currentUser].profile ? users[currentUser].profile : {name:'',phone:'',address:''};
}
function saveUserData(data) {
  let users = JSON.parse(localStorage.getItem('users'));
  users[currentUser].data = data;
  localStorage.setItem('users', JSON.stringify(users));
  debounceGistSync(currentUser, users[currentUser]);
}
function saveUserProfile(profile) {
  let users = JSON.parse(localStorage.getItem('users'));
  users[currentUser].profile = profile;
  localStorage.setItem('users', JSON.stringify(users));
  debounceGistSync(currentUser, users[currentUser]);
}
function loadProfileData() {
  const profile = getUserProfile();
  document.getElementById('userName').value = profile.name || '';
  document.getElementById('userPhone').value = profile.phone || '';
  document.getElementById('userAddress').value = profile.address || '';
}

// Add a new subject
function addSubject() {
  let name = prompt('Subject Name:');
  if (name) {
    let data = getUserData();
    if (data[name]) { alert("Subject already exists!"); return; }
    const color = randomFromArr(subjectColors);
    data[name] = { flashcards: [], color };
    saveUserData(data);
    loadSubjects();
  }
}

// Load all subjects
function loadSubjects() {
  const container = document.getElementById('subjectContainer');
  container.innerHTML = '';
  const data = getUserData();

  if (Object.keys(data).length === 0) {
    container.innerHTML = '<p>No subjects found. Add your first subject!</p>';
    return;
  }

  Object.keys(data).forEach((subject,i) => {
    const div = document.createElement('div');
    div.className = 'subject';
    div.style.backgroundColor = data[subject].color;
    const emoji = shapeEmojis[i%shapeEmojis.length];
    div.innerHTML =
      `<span>${subject}</span>
      <div class="tools">
        <button class="tool-btn" onclick="event.stopPropagation(); renameSubject('${subject}')">‚úèÔ∏è</button>
        <button class="tool-btn" onclick="event.stopPropagation(); deleteSubject('${subject}')">üóëÔ∏è</button>
      </div>
      <span class="geo-shape">${emoji}</span>`;
    div.onclick = () => openSubject(subject);
    container.appendChild(div);
  });
}

// Rename a subject
function renameSubject(name) {
  let newName = prompt('New name:', name);
  if (newName && newName !== name) {
    let data = getUserData();
    data[newName] = data[name];
    delete data[name];
    saveUserData(data);
    loadSubjects();
  }
}

// Delete a subject
function deleteSubject(name) {
  if (confirm(`Are you sure you want to delete "${name}" and all its flashcards?`)) {
    let data = getUserData();
    delete data[name];
    saveUserData(data);
    loadSubjects();
  }
}

// Open a subject to view flashcards
function openSubject(name) {
  currentSubject = name;
  document.getElementById('main').style.display = 'none';
  document.getElementById('subject-view').style.display = 'block';
  document.getElementById('subjectTitle').innerText = name;
  loadFlashcards();
}

// Go back to main view from subject view
function backToMain() {
  document.getElementById('subject-view').style.display = 'none';
  document.getElementById('main').style.display = 'block';
  currentSubject = null;
}

// Add a new flashcard
function addFlashcard() {
  let content = prompt('Enter flashcard content:');
  if (content) {
    let data = getUserData();
    const color = randomFromArr(flashcardColors);
    data[currentSubject].flashcards.push({ content, color });
    saveUserData(data);
    loadFlashcards();
  }
}

// Load all flashcards for current subject
function loadFlashcards() {
  const container = document.getElementById('flashcardContainer');
  container.innerHTML = '';
  let data = getUserData();
  const flashcards = data[currentSubject].flashcards;
  if (flashcards.length === 0) {
    container.innerHTML = '<p>No flashcards found. Add your first flashcard!</p>';
    return;
  }
  flashcards.forEach((fc, idx) => {
    const shapeHtml = `<span class="geo-shape">${randomFromArr(shapeEmojis)}</span>`;
    const div = document.createElement('div');
    div.className = 'flashcard';
    div.style.backgroundColor = fc.color;
    div.innerHTML = `<span>${fc.content}</span>
      <div class="tools">
        <button class="tool-btn" onclick="event.stopPropagation(); editFlashcard(${idx})">‚úèÔ∏è</button>
        <button class="tool-btn" onclick="event.stopPropagation(); deleteFlashcard(${idx})">üóëÔ∏è</button>
      </div>${shapeHtml}`;
    container.appendChild(div);
  });
}

// Edit flashcard
function editFlashcard(idx) {
  let data = getUserData();
  let fc = data[currentSubject].flashcards[idx];
  let newContent = prompt('Edit flashcard content:', fc.content);
  if (newContent) {
    fc.content = newContent;
    saveUserData(data);
    loadFlashcards();
  }
}

// Delete flashcard
function deleteFlashcard(idx) {
  if (confirm('Are you sure you want to delete this flashcard?')) {
    let data = getUserData();
    data[currentSubject].flashcards.splice(idx, 1);
    saveUserData(data);
    loadFlashcards();
  }
}

// Shuffle flashcards
function shuffleFlashcards() {
  let data = getUserData();
  let arr = data[currentSubject].flashcards;
  data[currentSubject].flashcards = shuffleArr(arr);
  saveUserData(data);
  loadFlashcards();
}

// Filter subjects
function filterSubjects() {
  const value = document.getElementById('searchInput').value.toLowerCase();
  const container = document.getElementById('subjectContainer');
  Array.from(container.children).forEach(child => {
    if (child.innerText.toLowerCase().includes(value)) {
      child.style.display = '';
    } else {
      child.style.display = 'none';
    }
  });
}

// Account settings
function showAccountSettings() {
  document.getElementById('main').style.display = 'none';
  document.getElementById('subject-view').style.display = 'none';
  document.getElementById('account-settings').style.display = 'block';
  document.getElementById('change-password').style.display = 'none';
  loadProfileData();
}

// Change password
function showChangePassword() {
  document.getElementById('main').style.display = 'none';
  document.getElementById('subject-view').style.display = 'none';
  document.getElementById('account-settings').style.display = 'none';
  document.getElementById('change-password').style.display = 'block';
}

// Back from settings
function backToMainFromSettings() {
  document.getElementById('account-settings').style.display = 'none';
  document.getElementById('change-password').style.display = 'none';
  document.getElementById('main').style.display = 'block';
}

// Save account settings
function saveAccountSettings() {
  const profile = {
    name: document.getElementById('userName').value,
    phone: document.getElementById('userPhone').value,
    address: document.getElementById('userAddress').value
  };
  saveUserProfile(profile);
  alert('Profile updated!');
  backToMainFromSettings();
}

// Change password logic
function changePassword() {
  const current = document.getElementById('currentPassword').value;
  const newPass = document.getElementById('newPassword').value;
  const confirm = document.getElementById('confirmPassword').value;
  let users = JSON.parse(localStorage.getItem('users'));
  if (users[currentUser].password !== current) {
    alert('Current password is incorrect.');
    return;
  }
  if (newPass !== confirm) {
    alert('New passwords do not match.');
    return;
  }
  users[currentUser].password = newPass;
  localStorage.setItem('users', JSON.stringify(users));
  debounceGistSync(currentUser, users[currentUser]);
  alert('Password changed successfully!');
  backToMainFromSettings();
}

// Logout
function logout() {
  currentUser = null;
  document.getElementById('main').style.display = 'none';
  document.getElementById('subject-view').style.display = 'none';
  document.getElementById('account-settings').style.display = 'none';
  document.getElementById('change-password').style.display = 'none';
  document.getElementById('auth-section').style.display = 'block';
}

// If user already logged in, show main
document.addEventListener("DOMContentLoaded",()=>{
  let users = JSON.parse(localStorage.getItem('users') || '{}');
  if (currentUser && users[currentUser]) {
    document.getElementById('auth-section').style.display = 'none';
    document.getElementById('main').style.display = 'block';
    loadSubjects();
    loadProfileData();
  }
});
</script>
</body>
</html>