<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Flashcard Hub</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-colors: #3b82f6,#6366f1,#06b6d4,#16a34a,#ca8a04,#ef4444,#a21caf,#7c3aed;
      --secondary-colors: #f1f5f9,#f3e8ff,#e0f2fe,#fef9c3,#f0fdf4,#fee2e2,#f3f4f6,#fef2f2;
      --shape-size: 80px;
      --shape-opacity: 0.10;
      --shadow-strong: 0 8px 32px 0 rgba(31, 41, 55, 0.18);
      --shadow-light: 0 2px 8px 0 rgba(31, 41, 55, 0.08);
      --border-radius: 16px;
      --transition: all 0.22s cubic-bezier(.42,1.49,.6,.97);
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Inter', 'Segoe UI',sans-serif;
      min-height: 100vh;
      margin: 0; padding: 0;
      background: var(--minimal-bg, #f1f5f9);
      color: #1e293b;
      position: relative;
      overflow-x: hidden;
      letter-spacing: 0.01em;
    }

    #bg-shapes { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 0; pointer-events: none; }

    .bg-shape {
      position: fixed;
      z-index: 0;
      opacity: var(--shape-opacity);
      filter: blur(1.5px);
      transition: var(--transition);
      pointer-events: none;
    }

    header {
      background: var(--primary-color, #3b82f6);
      color: #fff;
      padding: 1.3rem 1.5rem 1.15rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      box-shadow: var(--shadow-strong);
      z-index: 2;
      border-bottom-left-radius: var(--border-radius);
      border-bottom-right-radius: var(--border-radius);
      margin-bottom: 0.5rem;
    }
    header h1 {
      font-weight: 700;
      font-size: 1.55rem;
      letter-spacing: 0.01em;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      user-select: none;
      text-shadow: 0 2px 8px rgba(0,0,0,0.10);
    }
    .menu-btn {
      background: rgba(255,255,255,0.08);
      border: none;
      color: #fff;
      font-size: 2.1rem;
      cursor: pointer;
      padding: 0.6rem 0.9rem;
      border-radius: 50%;
      transition: background 0.15s, box-shadow 0.15s;
      box-shadow: 0 2px 8px rgba(31, 41, 55, 0.09);
      display: none;
    }
    .menu-btn:focus, .menu-btn:hover { background: rgba(255,255,255,0.14); outline: none; }

    .menu {
      position: absolute;
      top: 110%; right: 1.2rem;
      background: #fff;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-strong);
      width: 220px; z-index: 100;
      display: none;
      color: #1e293b;
      padding: 0.4rem 0;
      animation: menuShow 0.19s cubic-bezier(.42,1.49,.6,.97);
    }
    @keyframes menuShow { from { opacity: 0; transform: translateY(-12px); } to { opacity: 1; transform: none; } }
    .menu.show { display: block;}
    .menu-item {
      padding: 0.9rem 1.2rem;
      cursor: pointer;
      border-bottom: 1px solid #f1f5f9;
      color: #1e293b;
      background: transparent;
      font-weight: 500;
      font-size: 1.07rem;
      transition: background 0.18s, color 0.18s;
      border-radius: 0;
      user-select: none;
    }
    .menu-item:last-child { border-bottom: none; }
    .menu-item:hover {
      background: var(--primary-color, #3b82f6);
      color: #fff;
    }

    #auth-section {
      max-width: 410px;
      margin: 2.5rem auto 0 auto;
      padding: 2.5rem 2rem 2rem 2rem;
      background: #fff;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-strong);
      color: #1e293b;
      position: relative;
      z-index: 1;
    }
    .auth-title {
      text-align: center;
      color: var(--primary-color, #3b82f6);
      margin-bottom: 1.7rem;
      font-weight: 700;
      letter-spacing: 0.01em;
      font-size: 1.3rem;
      text-shadow: 0 2px 8px rgba(59,130,246,0.05);
    }
    .auth-form { display: flex; flex-direction: column; gap: 1.15rem; }
    .auth-input {
      padding: 0.87rem 1rem;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1.04rem;
      background: #f9fafb;
      color: #1e293b;
      font-family: inherit;
      transition: border 0.18s;
      letter-spacing: 0.01em;
    }
    .auth-input:focus { outline: none; border-color: var(--primary-color, #3b82f6); }
    .auth-button {
      background: var(--primary-color, #3b82f6);
      color: #fff;
      border: none;
      padding: 0.9rem 0;
      border-radius: 8px;
      font-size: 1.11rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.22s;
      box-shadow: 0 2px 8px rgba(59,130,246,0.10);
    }
    .auth-button:hover { background: #2563eb; }
    .auth-toggle {
      text-align: center;
      color: #64748b;
      margin-top: 0.7rem;
      font-size: 0.98rem;
    }
    .auth-toggle span {
      color: var(--primary-color, #3b82f6);
      cursor: pointer;
      text-decoration: underline;
      font-weight: 500;
      margin-left: 0.2em;
      transition: color 0.18s;
    }
    .auth-toggle span:hover { color: #2563eb; }

    #main, #subject-view, #account-settings, #change-password {
      padding: 1.2rem;
      display: none;
      max-width: 850px;
      margin: 0 auto 2rem auto;
      background: #fff;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-strong);
      color: #1e293b;
      position: relative;
      z-index: 1;
      margin-top: 2.3rem;
      min-height: 390px;
    }
    .section-title {
      font-size: 1.25rem;
      margin-bottom: 1.1rem;
      color: var(--primary-color, #3b82f6);
      font-weight: 700;
      letter-spacing: 0.01em;
    }
    .search-bar {
      width: 100%;
      padding: 0.8rem 1rem;
      margin-bottom: 1.2rem;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1rem;
      background: #f3f4f6;
      color: #1e293b;
      font-family: inherit;
      transition: border 0.18s;
    }
    .search-bar:focus { outline: none; border-color: var(--primary-color, #3b82f6);}
    .action-buttons {
      display: flex; gap: 0.55rem; margin-bottom: 1.05rem; flex-wrap: wrap;
    }

    .btn {
      padding: 0.77rem 1.15rem;
      font-size: 1.06rem;
      background: #e0e7ef;
      border: none; border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      display: flex; align-items: center; gap: 0.5rem;
      color: #1e293b;
      font-weight: 600;
      box-shadow: 0 1px 8px rgba(59,130,246,0.07);
    }
    .btn:hover {
      background: var(--primary-color, #3b82f6);
      color: #fff;
      transform: translateY(-2.5px) scale(1.035);
      box-shadow: 0 2px 18px rgba(59,130,246,0.13);
    }
    .btn-primary {
      background: var(--primary-color, #3b82f6);
      color: #fff;
    }
    .btn-primary:hover {
      background: #2563eb;
      color: #fff;
    }
    .subject, .flashcard {
      display: flex; justify-content: space-between; align-items: center;
      padding: 1.1rem 1.3rem;
      margin: 0.5rem 0;
      border-radius: 13px;
      background-color: #f9fafb;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: var(--shadow-light);
      color: #1e293b;
      border: 1.5px solid #e5e7eb;
      position: relative;
      font-size: 1.08rem;
      font-weight: 500;
      min-height: 58px;
    }
    .subject:hover, .flashcard:hover {
      transform: translateY(-2.5px) scale(1.027);
      box-shadow: 0 2px 12px rgba(59,130,246,0.09);
      background: #f1f5f9;
    }
    .geo-shape {
      position: absolute;
      bottom: 8px; right: 12px;
      opacity: 0.14; z-index: 0;
      pointer-events: none;
      font-size: 2.6rem;
      user-select: none;
    }

    .tools { display: flex; gap: 0.6rem; }
    .tool-btn {
      background: none; border: none; cursor: pointer;
      font-size: 1.08rem; color: #64748b;
      transition: color 0.18s;
      z-index: 2;
      border-radius: 6px;
      padding: 0.27rem;
    }
    .tool-btn:hover { color: var(--primary-color, #3b82f6); background: #f1f5f9;}
    .subject-container, .flashcard-container { margin-top: 1.1rem; }

    .settings-form {
      display: flex; flex-direction: column; gap: 1.12rem; margin-top: 1rem;
      max-width: 450px;
    }
    .form-group { display: flex; flex-direction: column; gap: 0.45rem; }
    .form-label { font-weight: 600; color: #334155;}
    .form-input {
      padding: 0.78rem 1rem;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1.08rem;
      background: #f8fafc;
      color: #1e293b;
      font-family: inherit;
      transition: border 0.18s;
    }
    .form-input:focus { outline: none; border-color: var(--primary-color, #3b82f6);}
    .back-btn { margin-bottom: 1rem; }

    .user-info-bar {
      background: #f1f5f9;
      font-size: 1.06rem;
      color: #475569;
      padding: 0.65rem 1.05rem;
      border-radius: 9px;
      margin-bottom: 1.1rem;
      display: flex;
      align-items: center;
      gap: 1.2rem;
      font-weight: 500;
      box-shadow: 0 1px 6px rgba(59,130,246,0.06);
    }

    @media (max-width: 600px) {
      header { padding: 0.85rem 0.5rem 0.85rem 0.7rem; }
      #auth-section { padding: 1.32rem 0.6rem 1.32rem 0.6rem; margin: 1.2rem 0.4rem 0 0.4rem;}
      .btn { padding: 0.5rem 0.7rem; font-size: 0.96rem; }
      .subject, .flashcard { padding: 0.7rem 0.6rem; font-size: 0.97rem; }
      #main, #subject-view, #account-settings, #change-password { padding: 0.65rem; }
      .settings-form { max-width: 99vw;}
      .user-info-bar { padding: 0.5rem 0.6rem; gap: 0.6rem; }
    }
  </style>
</head>
<body>
<div id="bg-shapes"></div>
<header>
  <h1>📚 Flashcard Hub</h1>
  <button class="menu-btn" id="menuBtn" style="display:none;">☰</button>
  <div class="menu" id="menu">
    <div class="menu-item" onclick="showAccountSettings()">Account Settings</div>
    <div class="menu-item" onclick="showChangePassword()">Change Password</div>
    <div class="menu-item" onclick="logout()" style="color: #ef4444;">Logout</div>
  </div>
</header>

<!-- Auth Section -->
<div id="auth-section">
  <h2 class="auth-title" id="authTitle">Sign In</h2>
  <div class="auth-form">
    <input type="text" id="username" class="auth-input" placeholder="Username" autocomplete="username" required>
    <input type="password" id="password" class="auth-input" placeholder="Password" autocomplete="current-password" required>
    <button onclick="handleAuth()" class="auth-button" id="auth-button">Sign In</button>
    <div class="auth-toggle">
      <span id="authToggleText" onclick="toggleAuth()">Don't have an account? <b>Sign Up</b></span>
    </div>
  </div>
</div>

<!-- Main Dashboard -->
<div id="main">
  <div class="user-info-bar" id="userInfoBar" style="display:none;"></div>
  <input type="text" id="searchInput" class="search-bar" placeholder="🔍 Search subjects..." oninput="filterSubjects()">
  <div class="action-buttons">
    <button class="btn btn-primary" onclick="addSubject()">
      <span>➕</span> Add Subject
    </button>
  </div>
  <div class="section-title">📁 Your Subjects:</div>
  <div class="subject-container" id="subjectContainer"></div>
</div>

<!-- Subject View -->
<div id="subject-view">
  <button class="btn back-btn" onclick="backToMain()">⬅ Back to Subjects</button>
  <h2 id="subjectTitle"></h2>
  <div class="action-buttons">
    <button class="btn btn-primary" onclick="addFlashcard()">
      <span>➕</span> Add Flashcard
    </button>
    <button class="btn" onclick="shuffleFlashcards()">
      <span>🔀</span> Shuffle
    </button>
  </div>
  <div class="flashcard-container" id="flashcardContainer"></div>
</div>

<!-- Account Settings -->
<div id="account-settings">
  <button class="btn back-btn" onclick="backToMainFromSettings()">⬅ Back</button>
  <h2 style="color:var(--primary-color,#3b82f6);margin-bottom:0.7rem;">Account Settings</h2>
  <div class="settings-form">
    <div class="form-group">
      <label class="form-label">Username (immutable)</label>
      <input type="text" id="userUsername" class="form-input" readonly style="background:#f1f5f9;color:#64748b;">
    </div>
    <div class="form-group">
      <label class="form-label">Name</label>
      <input type="text" id="userName" class="form-input">
    </div>
    <div class="form-group">
      <label class="form-label">Phone Number</label>
      <input type="tel" id="userPhone" class="form-input">
    </div>
    <div class="form-group">
      <label class="form-label">Address</label>
      <textarea id="userAddress" class="form-input" rows="3"></textarea>
    </div>
    <button class="btn btn-primary" onclick="saveAccountSettings()">Save Changes</button>
  </div>
</div>

<!-- Change Password -->
<div id="change-password">
  <button class="btn back-btn" onclick="backToMainFromSettings()">⬅ Back</button>
  <h2 style="color:var(--primary-color,#3b82f6);margin-bottom:0.7rem;">Change Password</h2>
  <div class="settings-form">
    <div class="form-group">
      <label class="form-label">Current Password</label>
      <input type="password" id="currentPassword" class="form-input" required>
    </div>
    <div class="form-group">
      <label class="form-label">New Password</label>
      <input type="password" id="newPassword" class="form-input" required>
    </div>
    <div class="form-group">
      <label class="form-label">Confirm New Password</label>
      <input type="password" id="confirmPassword" class="form-input" required>
    </div>
    <button class="btn btn-primary" onclick="changePassword()">Change Password</button>
  </div>
</div>

<script>
// ------ DYNAMIC COLOR & SHAPE BACKGROUND LOGIC ------
function randomFromArr(arr) { return arr[Math.floor(Math.random()*arr.length)]; }
function shuffleArr(arr) {
  let a = arr.slice(), n = a.length;
  for (let i = n-1; i > 0; i--) {
    let j = Math.floor(Math.random() * (i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}
function randomInt(min,max) { return min + Math.floor(Math.random()*(max-min+1)); }

const allPrimary = getComputedStyle(document.documentElement).getPropertyValue('--primary-colors').split(",");
const allSecondary = getComputedStyle(document.documentElement).getPropertyValue('--secondary-colors').split(",");
const bgShapes = [
  '<svg width="80" height="80"><circle cx="40" cy="40" r="38" fill="{c}" /></svg>',
  '<svg width="80" height="80"><rect x="8" y="8" width="64" height="64" rx="18" fill="{c}" /></svg>',
  '<svg width="80" height="80"><polygon points="40,8 72,72 8,72" fill="{c}" /></svg>',
  '<svg width="80" height="80"><ellipse cx="40" cy="48" rx="30" ry="20" fill="{c}" /></svg>',
  '<svg width="80" height="80"><line x1="12" y1="68" x2="68" y2="12" stroke="{c}" stroke-width="10" stroke-linecap="round"/></svg>',
  '<svg width="80" height="80"><path d="M40 8Q60 26 40 72Q20 26 40 8Z" fill="{c}" /></svg>',
  '<svg width="80" height="80"><polygon points="40,10 70,40 40,70 10,40" fill="{c}" /></svg>',
];
const shapeEmojis = ["🔵","🔶","🟩","🟣","🟦","🟧","🟡","🟫","🔺","⬛","⬜"];

function applyRandomTheme() {
  const p = randomFromArr(allPrimary).trim();
  const s = randomFromArr(allSecondary).trim();
  const bgh = randomFromArr(allSecondary).trim();
  document.documentElement.style.setProperty('--primary-color', p);
  document.documentElement.style.setProperty('--secondary-color', s);
  document.documentElement.style.setProperty('--minimal-bg', bgh);
}
function drawRandomBGShapes() {
  const num = window.innerWidth < 600 ? 2 : 5;
  const bg = document.getElementById('bg-shapes');
  bg.innerHTML = "";
  for (let i = 0; i < num; ++i) {
    const color = randomFromArr(allPrimary).trim();
    const svg = randomFromArr(bgShapes).replace("{c}",color);
    const div = document.createElement("div");
    div.className = "bg-shape";
    div.style.left = `${randomInt(3,90)}vw`;
    div.style.top = `${randomInt(4,80)}vh`;
    div.style.transform = `rotate(${randomInt(0,360)}deg) scale(${Math.random()*0.5+0.7})`;
    div.innerHTML = svg;
    bg.appendChild(div);
  }
}
applyRandomTheme();
drawRandomBGShapes();
window.addEventListener('resize', drawRandomBGShapes);

// ----- SYNC DATA TO REMOTE (GitHub Gist) -----
const GIST_STORAGE_KEY = "flashcardhub_gistid";
const GIST_API = "https://api.github.com/gists";
let gistId = localStorage.getItem(GIST_STORAGE_KEY) || null;
let gistSyncTimer = null;
function getGistAuthHeader() { return {}; }
function getUserGistKey(user) { return `flashcardhub_${user}.json`; }
async function saveUserToGist(user, userData) {
  const filename = getUserGistKey(user);
  let desc = "FlashcardHub User Data";
  let files = {};
  files[filename] = {content: JSON.stringify(userData)};
  if (!gistId) {
    let res = await fetch(GIST_API, {
      method:'POST',
      headers: {'Content-Type':'application/json', ...getGistAuthHeader()},
      body: JSON.stringify({description:desc,public:false,files})
    });
    let data = await res.json();
    if (data.id) {
      gistId = data.id;
      localStorage.setItem(GIST_STORAGE_KEY, gistId);
    }
  } else {
    await fetch(`${GIST_API}/${gistId}`, {
      method:'PATCH',
      headers: {'Content-Type':'application/json', ...getGistAuthHeader()},
      body: JSON.stringify({files})
    });
  }
}
async function loadUserFromGist(user) {
  if (!gistId) return null;
  const filename = getUserGistKey(user);
  let res = await fetch(`${GIST_API}/${gistId}`);
  let gist = await res.json();
  if (gist.files && gist.files[filename] && gist.files[filename].content) {
    return JSON.parse(gist.files[filename].content);
  }
  return null;
}
function debounceGistSync(user, userData) {
  clearTimeout(gistSyncTimer);
  gistSyncTimer = setTimeout(() => saveUserToGist(user, userData), 1500);
}

// ------ LOCAL/REMOTE DATA LOGIC -----
let isSignup = false;
let currentUser = null;
let currentSubject = null;
const subjectColors = allSecondary.map(x=>x.trim());
const flashcardColors = allPrimary.map(x=>x.trim());

const menuBtn = document.getElementById('menuBtn');
const menu = document.getElementById('menu');

// Menu is only visible when logged in
function updateMenuVisibility() {
  if (currentUser) {
    menuBtn.style.display = "";
  } else {
    menuBtn.style.display = "none";
    menu.classList.remove('show');
  }
}
menuBtn.addEventListener('click', () => { menu.classList.toggle('show'); });
document.addEventListener('click', (e) => {
  if (!menu.contains(e.target) && e.target !== menuBtn) menu.classList.remove('show');
});

// Toggle between sign in and sign up
function toggleAuth() {
  isSignup = !isSignup;
  document.getElementById('auth-button').innerText = isSignup ? 'Sign Up' : 'Sign In';
  document.getElementById('authTitle').innerText = isSignup ? 'Sign Up' : 'Sign In';
  document.getElementById('authToggleText').innerHTML = isSignup ?
    'Already have an account? <b>Sign In</b>' : "Don't have an account? <b>Sign Up</b>";
}

// Handle authentication
async function handleAuth() {
  const user = document.getElementById('username').value.trim();
  const pass = document.getElementById('password').value.trim();
  if (!user || !pass) {
    alert('Please enter both username and password');
    return;
  }
  let users = JSON.parse(localStorage.getItem('users') || '{}');
  if (isSignup) {
    if (users[user]) {
      alert('User already exists!');
    } else {
      users[user] = {
        password: pass,
        data: {},
        profile: { name: '', phone: '', address: '' }
      };
      localStorage.setItem('users', JSON.stringify(users));
      await saveUserToGist(user, users[user]);
      alert('Signup successful! Please sign in.');
      toggleAuth();
    }
  } else {
    let remote = await loadUserFromGist(user);
    if (remote) {
      users[user] = remote;
      localStorage.setItem('users', JSON.stringify(users));
    }
    if (users[user] && users[user].password === pass) {
      currentUser = user;
      document.getElementById('auth-section').style.display = 'none';
      document.getElementById('main').style.display = 'block';
      updateMenuVisibility();
      updateUserBar();
      loadSubjects();
      loadProfileData();
    } else {
      alert('Incorrect credentials.');
    }
  }
  document.getElementById('username').value = '';
  document.getElementById('password').value = '';
}

// Get/set user data (auto-sync to gist)
function getUserData() {
  let users = JSON.parse(localStorage.getItem('users'));
  return users && users[currentUser] && users[currentUser].data ? users[currentUser].data : {};
}
function getUserProfile() {
  let users = JSON.parse(localStorage.getItem('users'));
  return users && users[currentUser] && users[currentUser].profile ? users[currentUser].profile : {name:'',phone:'',address:''};
}
function saveUserData(data) {
  let users = JSON.parse(localStorage.getItem('users'));
  users[currentUser].data = data;
  localStorage.setItem('users', JSON.stringify(users));
  debounceGistSync(currentUser, users[currentUser]);
}
function saveUserProfile(profile) {
  let users = JSON.parse(localStorage.getItem('users'));
  users[currentUser].profile = profile;
  localStorage.setItem('users', JSON.stringify(users));
  debounceGistSync(currentUser, users[currentUser]);
}
function loadProfileData() {
  document.getElementById('userUsername').value = currentUser || "";
  const profile = getUserProfile();
  document.getElementById('userName').value = profile.name || '';
  document.getElementById('userPhone').value = profile.phone || '';
  document.getElementById('userAddress').value = profile.address || '';
}

// Show current user's details in bar
function updateUserBar() {
  const bar = document.getElementById('userInfoBar');
  if (!currentUser) { bar.style.display = "none"; return; }
  const profile = getUserProfile();
  bar.innerHTML =
    `<span><b>Username:</b> ${currentUser}</span>` +
    (profile.name ? `<span><b>Name:</b> ${profile.name}</span>` : "");
  bar.style.display = "";
}

// Add a new subject
function addSubject() {
  let name = prompt('Subject Name:');
  if (name) {
    let data = getUserData();
    if (data[name]) { alert("Subject already exists!"); return; }
    const color = randomFromArr(subjectColors);
    data[name] = { flashcards: [], color };
    saveUserData(data);
    loadSubjects();
  }
}

// Load all subjects
function loadSubjects() {
  const container = document.getElementById('subjectContainer');
  container.innerHTML = '';
  const data = getUserData();
  if (Object.keys(data).length === 0) {
    container.innerHTML = '<p style="opacity:0.8;color:#64748b;margin-left:0.6rem;">No subjects found. Add your first subject!</p>';
    return;
  }
  Object.keys(data).forEach((subject,i) => {
    const div = document.createElement('div');
    div.className = 'subject';
    div.style.backgroundColor = data[subject].color;
    const emoji = shapeEmojis[i%shapeEmojis.length];
    div.innerHTML =
      `<span>${subject}</span>
      <div class="tools">
        <button class="tool-btn" onclick="event.stopPropagation(); renameSubject('${subject}')">✏️</button>
        <button class="tool-btn" onclick="event.stopPropagation(); deleteSubject('${subject}')">🗑️</button>
      </div>
      <span class="geo-shape">${emoji}</span>`;
    div.onclick = () => openSubject(subject);
    container.appendChild(div);
  });
}

// Rename a subject
function renameSubject(name) {
  let newName = prompt('New name:', name);
  if (newName && newName !== name) {
    let data = getUserData();
    data[newName] = data[name];
    delete data[name];
    saveUserData(data);
    loadSubjects();
  }
}

// Delete a subject
function deleteSubject(name) {
  if (confirm(`Are you sure you want to delete "${name}" and all its flashcards?`)) {
    let data = getUserData();
    delete data[name];
    saveUserData(data);
    loadSubjects();
  }
}

// Open a subject to view flashcards
function openSubject(name) {
  currentSubject = name;
  document.getElementById('main').style.display = 'none';
  document.getElementById('subject-view').style.display = 'block';
  document.getElementById('subjectTitle').innerText = name;
  loadFlashcards();
}

// Go back to main view from subject view
function backToMain() {
  document.getElementById('subject-view').style.display = 'none';
  document.getElementById('main').style.display = 'block';
  currentSubject = null;
  updateUserBar();
}

// Add a new flashcard
function addFlashcard() {
  let content = prompt('Enter flashcard content:');
  if (content) {
    let data = getUserData();
    const color = randomFromArr(flashcardColors);
    data[currentSubject].flashcards.push({ content, color });
    saveUserData(data);
    loadFlashcards();
  }
}

// Load all flashcards for current subject
function loadFlashcards() {
  const container = document.getElementById('flashcardContainer');
  container.innerHTML = '';
  let data = getUserData();
  const flashcards = data[currentSubject].flashcards;
  if (flashcards.length === 0) {
    container.innerHTML = '<p style="opacity:0.8;color:#64748b;margin-left:0.6rem;">No flashcards found. Add your first flashcard!</p>';
    return;
  }
  flashcards.forEach((fc, idx) => {
    const shapeHtml = `<span class="geo-shape">${randomFromArr(shapeEmojis)}</span>`;
    const div = document.createElement('div');
    div.className = 'flashcard';
    div.style.backgroundColor = fc.color;
    div.innerHTML = `<span>${fc.content}</span>
      <div class="tools">
        <button class="tool-btn" onclick="event.stopPropagation(); editFlashcard(${idx})">✏️</button>
        <button class="tool-btn" onclick="event.stopPropagation(); deleteFlashcard(${idx})">🗑️</button>
      </div>${shapeHtml}`;
    container.appendChild(div);
  });
}

// Edit flashcard
function editFlashcard(idx) {
  let data = getUserData();
  let fc = data[currentSubject].flashcards[idx];
  let newContent = prompt('Edit flashcard content:', fc.content);
  if (newContent) {
    fc.content = newContent;
    saveUserData(data);
    loadFlashcards();
  }
}

// Delete flashcard
function deleteFlashcard(idx) {
  if (confirm('Are you sure you want to delete this flashcard?')) {
    let data = getUserData();
    data[currentSubject].flashcards.splice(idx, 1);
    saveUserData(data);
    loadFlashcards();
  }
}

// Shuffle flashcards
function shuffleFlashcards() {
  let data = getUserData();
  let arr = data[currentSubject].flashcards;
  data[currentSubject].flashcards = shuffleArr(arr);
  saveUserData(data);
  loadFlashcards();
}

// Filter subjects
function filterSubjects() {
  const value = document.getElementById('searchInput').value.toLowerCase();
  const container = document.getElementById('subjectContainer');
  Array.from(container.children).forEach(child => {
    if (child.innerText.toLowerCase().includes(value)) {
      child.style.display = '';
    } else {
      child.style.display = 'none';
    }
  });
}

// Account settings
function showAccountSettings() {
  document.getElementById('main').style.display = 'none';
  document.getElementById('subject-view').style.display = 'none';
  document.getElementById('account-settings').style.display = 'block';
  document.getElementById('change-password').style.display = 'none';
  loadProfileData();
}

// Change password
function showChangePassword() {
  document.getElementById('main').style.display = 'none';
  document.getElementById('subject-view').style.display = 'none';
  document.getElementById('account-settings').style.display = 'none';
  document.getElementById('change-password').style.display = 'block';
}

// Back from settings
function backToMainFromSettings() {
  document.getElementById('account-settings').style.display = 'none';
  document.getElementById('change-password').style.display = 'none';
  document.getElementById('main').style.display = 'block';
  updateUserBar();
}

// Save account settings
function saveAccountSettings() {
  const profile = {
    name: document.getElementById('userName').value,
    phone: document.getElementById('userPhone').value,
    address: document.getElementById('userAddress').value
  };
  saveUserProfile(profile);
  updateUserBar();
  alert('Profile updated!');
  backToMainFromSettings();
}

// Change password logic
function changePassword() {
  const current = document.getElementById('currentPassword').value;
  const newPass = document.getElementById('newPassword').value;
  const confirm = document.getElementById('confirmPassword').value;
  let users = JSON.parse(localStorage.getItem('users'));
  if (users[currentUser].password !== current) {
    alert('Current password is incorrect.');
    return;
  }
  if (newPass !== confirm) {
    alert('New passwords do not match.');
    return;
  }
  users[currentUser].password = newPass;
  localStorage.setItem('users', JSON.stringify(users));
  debounceGistSync(currentUser, users[currentUser]);
  alert('Password changed successfully!');
  backToMainFromSettings();
}

// Logout
function logout() {
  currentUser = null;
  document.getElementById('main').style.display = 'none';
  document.getElementById('subject-view').style.display = 'none';
  document.getElementById('account-settings').style.display = 'none';
  document.getElementById('change-password').style.display = 'none';
  document.getElementById('auth-section').style.display = 'block';
  updateMenuVisibility();
}

// If user already logged in, show main
document.addEventListener("DOMContentLoaded",()=>{
  let users = JSON.parse(localStorage.getItem('users') || '{}');
  if (currentUser && users[currentUser]) {
    document.getElementById('auth-section').style.display = 'none';
    document.getElementById('main').style.display = 'block';
    updateMenuVisibility();
    updateUserBar();
    loadSubjects();
    loadProfileData();
  } else {
    updateMenuVisibility();
  }
});
</script>
</body>
</html>